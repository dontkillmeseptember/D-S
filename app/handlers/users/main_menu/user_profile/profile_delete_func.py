from data.loader import dp, bot
from data.config import ConfigBot
from data.loader_keyboard import LoaderInlineKeyboards
from data.states_groups import ProfileState

from database.requests.user_db import load_user_data, is_user_in_data, save_user_data
from database.requests.admin_db import load_admin_data, is_admin_in_data, save_admin_data

from misc.loggers import logger
from misc.libraries import types, FSMContext

from keyboards.users.ReplyKeyboard.ReplyKeyboard_all import hide_keyboard

"""–°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
@dp.callback_query_handler(lambda callback_data: callback_data.data == "DELETE_ACCOUNT")
async def delete_account_handler(callback_query: types.CallbackQuery) -> ProfileState:
	"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –≤—ã–≤–æ–¥–æ–º –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
	USER_DATA_DB = load_user_data()

	try:
		"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: USER_ID"""
		USER_ID = ConfigBot.USERID(callback_query)

		if is_user_in_data(USER_ID, USER_DATA_DB):
			await bot.delete_message(callback_query.message.chat.id, callback_query.message.message_id)

			""""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ –≤—ã–≤–æ–¥–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª—å"""
			back_profile_inline_keyboard = LoaderInlineKeyboards(callback_query).INLINE_KEYBOARDS_BACK_PROFILEMENU

			await bot.send_message(chat_id = callback_query.message.chat.id, 
						  		   text = f"üí¨ –î–ª—è <b>—É–¥–∞–ª–µ–Ω–∏—è</b> –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞, <a href='https://t.me/{ConfigBot.USERNAME(callback_query)}'>{ConfigBot.USERLASTNAME(callback_query)}</a>, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>—Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</b>.\n\n–≠—Ç–æ—Ç —à–∞–≥ –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–∞—à–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.\n\n"
						  		   		  f"–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –≤–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∞—à–µ–π <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b></a>",
								   reply_markup = back_profile_inline_keyboard)

			"""–ü–µ—Ä–µ—Ö–æ–¥–∏–º —Ñ–∞–∑—É, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å –æ—Ç —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
			await ProfileState.SendUserPasswordState.set()
		else:
			logger.warning(f"‚ö†Ô∏è –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [@{ConfigBot.USERNAME(callback_query)}] –ø–æ–ø—ã—Ç–∞–ª—Å—è —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç.")
	except Exception as e:
		logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: %s", e)

"""–°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–∞–∑—ã, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å –æ—Ç —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
@dp.message_handler(state = ProfileState.SendUserPasswordState)
async def send_user_password_handler(message: types.Message) -> ProfileState:
	try:
		"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é c –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: USER_PASSWORD, USER_MESSAGE"""
		USER_PASSWORD = ConfigBot.USERPASSWORD(message)
		USER_MESSAGE = ConfigBot.USERMESSAGE(message)

		if USER_PASSWORD == USER_MESSAGE:
			await message.answer(f"üí¨ –û—Ç–ª–∏—á–Ω–æ, <a href='https://t.me/{ConfigBot.USERNAME(message)}'>{ConfigBot.USERLASTNAME(message)}</a>! –ü–∞—Ä–æ–ª—å –æ—Ç –≤–∞—à–µ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ <b>–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</b>.\n\n"
								 f"–î–ª—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ <b>\"–ü–û–î–¢–í–ï–†–ñ–î–ê–Æ\"</b> (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫). –≠—Ç–æ—Ç —à–∞–≥ –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.\n\n"
								 f"–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –≤–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∞—à–µ–π <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b></a>")
			
			"""–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ñ–∞–∑—É, –≥–¥–µ –≤–≤–æ–¥—è—Ç –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞"""
			await ProfileState.SendApprovedState.set()

		elif USER_PASSWORD != USER_MESSAGE:
			await message.answer(f"‚ö†Ô∏è –ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ –ø–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω <b>–Ω–µ–≤–µ—Ä–Ω–æ</b>. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\n\n"
								 f"–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º, –≤—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–π <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</b></a>.")
		else:
			logger.warning(f"‚ö†Ô∏è –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [@{ConfigBot.USERNAME(message)}] –ø–æ–ø—ã—Ç–∞–ª—Å—è –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞.")
	except Exception as e:
		logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: %s", e)

"""–°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–∞–∑—ã, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
@dp.message_handler(state = ProfileState.SendApprovedState)
async def send_user_password_handler(message: types.Message, state: FSMContext) -> FSMContext:
	"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –≤—ã–≤–æ–¥–æ–º –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞—Ö"""
	USER_DATA_DB = load_user_data()
	ADMIN_DATA_DB = load_admin_data()

	try:
		"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é c –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: USER_MESSAGE, USER_ID"""
		USER_MESSAGE = ConfigBot.USERMESSAGE(message)
		USER_ID = ConfigBot.USERID(message)

		if USER_MESSAGE == "–ü–û–î–¢–í–ï–†–ñ–î–ê–Æ":
			"""–£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"""
			if is_admin_in_data(USER_ID, ADMIN_DATA_DB):
				del ADMIN_DATA_DB[str(USER_ID)]

				save_admin_data(ADMIN_DATA_DB)

			del USER_DATA_DB[str(USER_ID)]

			save_user_data(USER_DATA_DB)

			await message.answer(f"üí¨ <a href='https://t.me/{ConfigBot.USERNAME(message)}'>{ConfigBot.USERLASTNAME(message)}</a>! –í—ã —É—Å–ø–µ—à–Ω–æ –≤–≤–µ–ª–∏ <b>–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</b> –í–∞—à–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ <b>–Ω–∞–≤—Å–µ–≥–¥–∞</b>.\n\n"
								 "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–∞—à–µ <a href='#'><b>–ø—Ä–æ—â–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ</b></a> –æ—Ç –∫–æ–º–∞–Ω–¥—ã, –≤ –∫–æ—Ç–æ—Ä–æ–º –º—ã –≤—ã—Ä–∞–∂–∞–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ –∂–µ–ª–∞–µ–º –≤—Å–µ–≥–æ –Ω–∞–∏–ª—É—á—à–µ–≥–æ.",
								 reply_markup = hide_keyboard())

			await state.finish()

		elif USER_MESSAGE != "–ü–û–î–¢–í–ï–†–ñ–î–ê–Æ":
			await message.answer("‚ö†Ô∏è –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –≤—ã –≤–≤–µ–ª–∏ <b>–Ω–µ–≤–µ—Ä–Ω–æ–µ</b> –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.\n\n"
								 "–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–≤–æ–¥–∏—Ç–µ —Å–ª–æ–≤–æ <b>\"–ü–û–î–¢–í–ï–†–ñ–î–ê–Æ\"</b> (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n\n"
								f"–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –≤–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∞—à–µ–π <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b></a>")
		else:
			logger.warning("‚ö†Ô∏è USER_MESSAGE –Ω–µ —Ä–æ–≤–Ω—è–µ—Ç—Å—è —Å–ª–æ–≤—É –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ")
	except Exception as e:
		logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: %s", e)