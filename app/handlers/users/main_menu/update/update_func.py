from data.loader import dp, bot
from data.config import ConfigBot, ConfigBotAsync
from data.config_Keyboard import ConfigReplyKeyboard
from data.loader_keyboard import LoaderReplyKeyboards

from database.requests.version_db import get_bot_version
from database.requests.user_db import load_user_data, is_user_in_data, save_user_data

from misc.libraries import types, RetryAfter
from misc.loggers import logger

"""–°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /update"""
@dp.message_handler(commands=("update"))
async def update_command(message: types.Message) -> None:
	"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –≤—ã–≤–æ–¥–æ–º –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã."""
	USER_DATA_DB = load_user_data()
	VERSION_BOT = get_bot_version()

	try:
		"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: USER_ID."""
		USER_ID = ConfigBot.USERID(message)

		if is_user_in_data(USER_ID, USER_DATA_DB):
			"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –≤—ã–≤–æ–¥–æ–º —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
			USER_VERSION_BOT = ConfigBot.USERVERSIONBOT(message)

			if USER_VERSION_BOT == VERSION_BOT:
				await message.answer(f"üí¨ <a href='https://t.me/{ConfigBot.USERNAME(message)}'>{ConfigBot.USERLASTNAME(message)}</a>, –±–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤–∞—Å –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–º—É –±–æ—Ç—É.\n\n"
									 f"–ú—ã —Ä–∞–¥—ã —Å–æ–æ–±—â–∏—Ç—å, —á—Ç–æ –≤—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ <b>–ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –±–æ—Ç–∞ - v{VERSION_BOT}</b>\n\n"
									 f"–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b></a>.")
				
			elif USER_VERSION_BOT != VERSION_BOT:
				"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –≤—ã–≤–æ–¥–æ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞."""
				update_bot_reply_keyboard = LoaderReplyKeyboards(message).KEYBOARDS_UPDATE_BOT

				await message.answer(f"üí¨ <a href='https://t.me/{ConfigBot.USERNAME(message)}'>{ConfigBot.USERLASTNAME(message)}</a>, –º—ã —Ö–æ—Ç–∏–º —Å–æ–æ–±—â–∏—Ç—å –≤–∞–º, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ <b>—É—Å—Ç–∞—Ä–µ–≤—à—É—é –≤–µ—Ä—Å–∏—é –±–æ—Ç–∞ - v{USER_VERSION_BOT}</b>.\n\n"
						 			 f"–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –æ–ø—ã—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –¥–æ <b>–ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ - v{VERSION_BOT}</b>.\n\n"
									 f"‚ùï –ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É <b>¬´{ConfigReplyKeyboard().DOWNLOAD_UPDATE[2:] + VERSION_BOT}¬ª</b>. –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º.\n\n–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b></a>.", 
									 reply_markup = update_bot_reply_keyboard)

			else:
				logger.warning("‚ö†Ô∏è USER_VERSION_BOT –Ω–µ —Ä–æ–≤–Ω—è–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞.")
		
		elif not is_user_in_data(USER_ID, USER_DATA_DB):
			logger.warning(f"‚ö†Ô∏è –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [@{ConfigBot.USERNAME(message)}] –ø–æ–ø—ã—Ç–∞–ª—Å—è –≤–µ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—É /update.")
		
		else:
			logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
	except Exception as e:
		logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: %s", e)

"""–°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /update"""
@dp.message_handler(lambda message: message.text == ConfigReplyKeyboard().DOWNLOAD_UPDATE + ConfigBot().VERSION + " ‚Ä¢")
async def update_handler(message: types.Message) -> None:
	"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞."""
	USER_DATA_DB = load_user_data()
	VERSION_BOT = get_bot_version()

	try:
		"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: USER_ID."""
		USER_ID = ConfigBot.USERID(message)

		if is_user_in_data(USER_ID, USER_DATA_DB):
			message_text = await message.answer("„Ö§")

			"""–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞ 1, 2 –∏ 3."""
			await ConfigBotAsync.UPDATE_PROGRESS(msg = message_text, update_stage = 1, time_sleep = 5, version = VERSION_BOT, type = message)
			await ConfigBotAsync.UPDATE_PROGRESS(msg = message_text, update_stage = 2, time_sleep = 10, version = VERSION_BOT, type = message)
			await ConfigBotAsync.UPDATE_PROGRESS(msg = message_text, update_stage = 3, time_sleep = 5, version = VERSION_BOT, type = message)

			"""–£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
			await bot.delete_message(message.chat.id, message_text.message_id)

			"""–û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ—Ç–æ—Ä–∞—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
			USER_DATA_DB[str(ConfigBot.USERID(message))]["VERSION_BOT"] = VERSION_BOT

			save_user_data(USER_DATA_DB)

			"""–û—Ç–æ–±—Ä–∞–∑–∏—Ç–µ –∫–æ–Ω–µ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –º–µ–Ω—é."""
			finish_update_reply_keyboards = LoaderReplyKeyboards(message).KEYBOARDS_FINISH_UPDATE

			await message.answer(f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, <a href='https://t.me/{ConfigBot.USERNAME(message)}'>{ConfigBot.USERLASTNAME(message)}</a>, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ <b>v{VERSION_BOT}</b> —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!\n\n"
								 f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É <b>¬´{ConfigReplyKeyboard().FINISH_DOWNLOAD[2:-2]}¬ª</b>. –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.\n\n"
								 f"–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ <a href='https://t.me/{ConfigBot().AUTHOR}'><b>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b></a>.",
								 reply_markup = finish_update_reply_keyboards)

		elif not is_user_in_data(USER_ID, USER_DATA_DB):
			logger.warning(f"‚ö†Ô∏è –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [@{ConfigBot.USERNAME(message)}] –ø–æ–ø—ã—Ç–∞–ª—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.")

		else:
			logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
	except RetryAfter as e:
		logger.warning(f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [@{ConfigBot.USERNAME(message)}] –ø—Ä–µ–≤—ã—à–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ {e.timeout} —Å–µ–∫—É–Ω–¥.")

	except Exception as e:
		logger.error("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: %s", e)